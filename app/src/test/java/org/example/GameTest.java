/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example;

import static org.junit.jupiter.api.Assertions.*;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import org.example.domain.Character;
import org.example.domain.Enemy;
import org.example.domain.GameMap;
import org.example.service.GameService;
import org.example.service.impl.GameServiceImpl;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

class GameTest {

    GameService gameService;
    String playerName;
    GameMap gameMap;

    @BeforeEach
    public void setUp() throws IOException {
        gameService = new GameServiceImpl("game_data_test.txt");
        playerName = "player_1";

        gameService.createCharacter(playerName);
        gameMap = gameService.initMap();
        gameMap.getCharacter().setLocationX(0);
        gameMap.getCharacter().setLocationY(1);
    }

    @AfterEach
    public void tearDown() {
        new File("game_data_test.txt").delete();
    }

    @Test
    void givenCreatedCharacter_WhenQuery_ThenReturnIt() {
        Character character = gameService.createCharacter(playerName);

        assertEquals(playerName, character.getName());
        assertEquals(playerName, gameService.queryCurrentCharacter().getName());
    }

    @Test
    void shouldGenerateEnemiesWhenInitializingMap() throws IOException {
        GameMap gameMap = gameService.initMap();

        assertFalse(gameMap.getEnemies().isEmpty());
    }

    @Test
    void enemyShouldDisappearWhenAttacked() {
        gameMap.setEnemies(new ArrayList<>(Arrays.asList(
                Enemy.builder().locationX(0).locationY(2).bonusExp(1).build(),
                Enemy.builder().locationX(3).locationY(4).bonusExp(1).build())));

        gameService.attack(gameMap);

        assertEquals(1, gameMap.getEnemies().size());
    }

    @Test
    void enemyShouldRemainIntactWhenTooFar() {
        gameMap.setEnemies(new ArrayList<>(Arrays.asList(
                Enemy.builder().locationX(0).locationY(3).bonusExp(1).build(),
                Enemy.builder().locationX(3).locationY(4).bonusExp(1).build())));

        gameService.attack(gameMap);

        assertEquals(2, gameMap.getEnemies().size());
    }

    @Test
    void whenSaveAndLoadGameStatus_shouldRecoverCorrectly() throws IOException {
        gameMap.setEnemies(new ArrayList<>(Arrays.asList(
                Enemy.builder().locationX(0).locationY(3).bonusExp(1).build(),
                Enemy.builder().locationX(3).locationY(4).bonusExp(1).build())));

        gameService.saveGame();
        gameService.initMap();
        GameMap loadedMap = gameService.queryCurrentMap();

        assertEquals(playerName, loadedMap.getCharacter().getName());
        assertEquals(0, loadedMap.getCharacter().getLocationX());
        assertEquals(1, loadedMap.getCharacter().getLocationY());
        assertEquals(2, loadedMap.getEnemies().size());
        assertEquals(0, loadedMap.getEnemies().get(0).getLocationX());
        assertEquals(3, loadedMap.getEnemies().get(0).getLocationY());
        assertEquals(3, loadedMap.getEnemies().get(1).getLocationX());
        assertEquals(4, loadedMap.getEnemies().get(1).getLocationY());
    }
}
